

**Elasticsearch** (эластичный поиск) — распределённый (distributed), RESTful поисковой движок по всему тексту (full-text search).

*Elasticsearch* использует JSON-документы без схемы. Эти документы передаются при помощи REST API для сохранения их в хранилище и поиска.

*Elasticsearch* построен поверх поискового движка **Apache Lucene**, написанном на *Java*.

## Индекс, тип, документ
**Индекс** (Index) — эквивалент *базы данных* в SQL или NoSQL.

**Тип** (Type) — эквивалент *таблицы* в SQL или *коллекции* в NoSQL.

Имеется *тип по умолчанию*, который *создаётся автоматически* (`_doc`) при *создании индекса*.

**Документ** (Document) — эквивалент *строки* в SQL или *документа* в NoSQL.

Документы хранятся в JSON-формате
```js
 {
    "_index": "notes",
    "_type": "_doc",
    "_id": "sYKRT3EBYbOH8y9AHDYY",
    "_source": {
      "name": "Elasticsearch",
      "author": "Max-Starling",
      "date": "2020-04-07T23:15:50Z"
    }
}
```

## Полнотекстовый поиск и индексирование

**Полнотекстовый поиск** (Full text searching) — *поиск документов* не по их идентификаторам, а *по их содержимому*.

**Индексирование** (Indexing) в *поисковых системах* — процесс *добавления сведений* (о сайте) *роботом поисковой машины* в *базу данных*, которая используется для *полнотекстового поиска информации* на *проиндексированных сайтах*.

В рамках *Elasticsearch* **индексированием** называют *запись данных* в *индекс*.

## Реплики и шарды

*Индексы* обычно *разредяются* на *несколько подиндексов* (sub-indices), называемые **осколками**, **шардами** (shards). *Каждый шард хранит* какую-то *часть документов индекса*. 

**Шардинг** (Sharding) — процесс разбиения на шарды и одна из стратегий масштабирования баз данных.

*Шарды распределяются* между *несколькими узлами, экземплярами приложения* (Elasticsearch nodes). 

*Каждый шард* является *экземпляром дижка Lucene*. Таким образом *все данные хранятся в Lucene*, а *Elasticsearch распределённо управляет* этими *данными*.

*Количество шардов* указано в *настройках индекса* в *свойстве* `number_of_shards`.

*Резервная копия всех шардов* называется **репликой** (replica). Если *один экземпляр приложения падает* вместе с данными, которые на нём хранились, *реплика* позволяет *не терять* эти *данные*.

**Репликация** (Sharding) — процесс, при котором данные постоянно **реплицируются** (копируются) на один или несколько других серверов. Репликация тоже является стратегией масштабирования баз данных.

Количество *реплик* указано в *настройках индекса* в *свойстве* `number_of_replicas`.

## Перевёрнутые индексы

*Elasticsearch хранит данные* как **перевёрнутые индексы** (inverted indexes) *на диске*, что позволяет очень быстро искать данные.

Поисковой движок Apache Lucene реализует перевёрнутый индекс, используя структуру данных [**список с пропусками**](https://github.com/Max-Starling/Notes/blob/master/Algorithms-Structures.md#список-с-пропусками) (Skip List). Эта структура данных основана на связных списках, но по трудоёмкости сравнима с **двоичным деревом поиска** (B-tree).

Разработчики *Lucene* выбрали *список с пропусками вместо двоичного дерева*, поскольку он *требует меньшее число обращений* к *диску*. 

Индекс в Lucene очень похож на индекс в конце книги: указываются определённый список ключевых слов (важных определений) и рядом страницы, на которых они упоминаются.
![Index example](https://i.imgur.com/yIglkAe.jpg)

Аналогично работает и Google. Рядом с проиндексированными словами сохраняются ссылки на страницы. Таким образом их можно найти при поиске. Это же касается и Elasticsearch, только вместо ссылок на страницы используются ссылки на документы.

### Пример с разбиением на слова

Посмотрим, как обратные индексы работают на примере. 

Пусть у нас есть два текста.
* `I don't like to work alone`.  
* `I often work on weekends`.

Разобьём их на слова и выберем только уникальные слова из обоих текстов.

Множество уникальных слов будет следующим: `I`, `don't`, `like`, `to`, `work`, `alone`, `often`, `on`, `weekends`.

Сохраним каждое уникальное слово в память, а рядом с ним — ссылки на те документы, которые используют это слово.

| Слово     | Документ #1 | Документ #2 |
| --------- | ----------- | ----------- |
| I         |     +       |      +      |
| don't     |     +       |             |
| like      |     +       |             |
| to        |     +       |             |
| work      |     +       |      +      |
| alone     |     +       |             |
| often     |             |      +      |
| on        |             |      +      |
| weekends  |             |      +      |

Теперь произведём поиск по словам. Документ либо содержит слово, либо не содержит.

Например, поиск по слову `work` выдаст оба документа, по слову `like` — только первый, по слову `often` — только второй.

Если ввести искать по двум словам одновремено `often` и `alone`, то выдадутся оба документа.

| Слово     | Документ #1 | Документ #2 |
| --------- | ----------- | ----------- |
| alone     |     +       |             |
| often     |             |      +      |

