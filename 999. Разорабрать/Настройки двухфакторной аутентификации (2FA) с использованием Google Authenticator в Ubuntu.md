Для настройки двухфакторной аутентификации (2FA) с использованием Google Authenticator в Ubuntu, нужно выполнить несколько шагов. Будем использовать PAM-модуль для Google Authenticator, который интегрируется с системой.

### Шаги установки и настройки:

1. **Установите Google Authenticator PAM-модуль**:
   Откройте терминал и выполните команду для установки необходимого пакета:
   ```bash
   sudo apt update
   sudo apt install libpam-google-authenticator
   ```

2. **Настройте Google Authenticator для пользователя**:
   Выполните команду для текущего пользователя, под которым вы хотите настроить двухфакторную аутентификацию:
   ```bash
   google-authenticator
   ```
![[Pasted image 20241006115744.png]]
   В процессе выполнения вас попросят ответить на несколько вопросов:
   - **Создать новый секретный ключ (Yes/No)?** — Введите `y` (yes), чтобы создать новый ключ.
   - **Хотите ли вы обновить файл конфигурации (Yes/No)?** — Введите `y` (yes), чтобы сохранить изменения.
   - **Включить использование тайм-аутов (Yes/No)?** — Введите `y` для использования временных одноразовых паролей (TOTP).
   - **Разрешить несколько попыток (Yes/No)?** — Вы можете ввести `y` для разрешения нескольких попыток ввода кода за один временной интервал.
   - **Желаете ли вы настроить ограничение по времени использования одного кода (Yes/No)?** — Это ограничение по времени на ввод сгенерированного кода. Обычно вводят `y`.

   В результате выполнения команды отобразится QR-код, который нужно отсканировать с помощью приложения Google Authenticator на вашем мобильном устройстве. Также будут показаны коды для восстановления на случай потери доступа к устройству.

3. **Настройка PAM для SSH (и/или входа в систему)**:
   
   Откройте файл конфигурации PAM для SSH:
   ```bash
   sudo nano /etc/pam.d/sshd
   ```

   Добавьте следующую строку в начало файла:
   ```
   auth required pam_google_authenticator.so
   ```

   Если вы хотите использовать 2FA для локальной аутентификации (например, при входе в систему через терминал), добавьте эту строку в файл `/etc/pam.d/common-auth`.
   
4. **Настройка SSH для работы с 2FA**:
   
   Откройте файл конфигурации SSH:
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```

   Найдите и измените следующие строки:
   ```bash
   ChallengeResponseAuthentication yes
   ```

   Включите использование PAM:
   ```bash
   UsePAM yes
   ```

   Если вы хотите, чтобы пароль и 2FA запрашивались одновременно, добавьте:
   ```bash
   AuthenticationMethods publickey,password publickey,keyboard-interactive
   ```

   Сохраните файл и перезапустите SSH:
   ```bash
   sudo systemctl restart ssh
   ```

5. **Тестирование**:
   
   Пробуем подключиться через SSH к вашему серверу, и система должна запросить одноразовый код после ввода пароля.

![[Pasted image 20241006115755.png]]
### Важные моменты:
- **Бэкап кода**: Обязательно сохраните резервные коды, которые будут сгенерированы при настройке Google Authenticator. Это поможет вам в случае потери доступа к устройству.
- **Совместимость с SSH**: Если вы используете ключи SSH, убедитесь, что они работают корректно с двухфакторной аутентификацией.

